<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>English ‚Äì Fill the Blank</title>
<style>
:root{
  --bg:#191919; --card:#0f1216; --ink:#eaf2f7; --muted:#98a5b3;
  --accent:#00ffa6; --wrong:#ff5f5f; --right:#22c55e; --edge:#21262d;
}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto}
.wrapper{min-height:100%;display:flex;align-items:center;justify-content:center;padding:18px}
.app{width:min(96vw,640px)}
h1{margin:0 0 10px;font-size:20px}
.card{background:var(--card);border:1px solid var(--edge);border-radius:14px;box-shadow:0 18px 48px rgba(0,0,0,.55);padding:16px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0}
.badge{background:#121820;border:1px solid #1c222a;border-radius:10px;padding:6px 10px;font-weight:800;color:#cfe6dd}
select,button{background:#12161c;border:1px solid #26303a;color:#e8eef5;border-radius:10px;padding:8px 12px;cursor:pointer}
button.primary{background:var(--accent);border:none;color:#062017;font-weight:900}
button:disabled{opacity:.55;cursor:not-allowed}
.question{font-size:18px;line-height:1.5;margin:6px 0 12px}
.blank{display:inline-block;min-width:110px;border-bottom:2px dashed #2c3440;text-align:center}
.opts{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.opt{border:1px solid #26303a;background:#12161c;border-radius:12px;padding:10px 12px;text-align:left}
.opt.kb::before{content:attr(data-kb);display:inline-block;width:20px;height:20px;border-radius:6px;
  background:#0d1116;border:1px solid #1e252c;color:#cdd7e3;font-weight:800;line-height:20px;text-align:center;margin-right:8px}
.opt:hover{border-color:#34414f}
.opt.correct{border-color:#1f7f4a;background:rgba(34,197,94,.12)}
.opt.wrong{border-color:#7f2b2b;background:rgba(255,95,95,.12)}
.meta{display:flex;justify-content:space-between;align-items:center;margin-top:12px;color:var(--muted);font-size:13px}
.progress{height:8px;background:#141a20;border:1px solid #1f2730;border-radius:6px;overflow:hidden}
.fill{height:100%;background:linear-gradient(90deg,#00ffa6,#2dd4bf)}
.feedback{margin-top:8px;font-size:14px}
.feedback.good{color:var(--right)} .feedback.bad{color:var(--wrong)}
.center{display:flex;justify-content:center;gap:10px;margin-top:12px}
.small{font-size:12px;color:#9aabbc;text-align:center;margin-top:8px}
hr{border:none;border-top:1px solid #1f2730;margin:12px 0}
</style>
</head>
<body>
<div class="wrapper">
  <div class="app">
    <h1>English ‚Äì Fill the Blank ‚úçÔ∏è</h1>

    <div class="row">
      <span class="badge">Mode</span>
      <select id="qCount">
        <option value="8">8 Qs</option>
        <option value="10" selected>10 Qs</option>
        <option value="15">15 Qs</option>
      </select>
      <span class="badge">Timer</span>
      <select id="timerSel">
        <option value="12">12s / Q</option>
        <option value="15" selected>15s / Q</option>
        <option value="20">20s / Q</option>
      </select>
      <button id="start" class="primary">Start</button>
      <span class="badge" id="best">Best: ‚Äî</span>
    </div>

    <div class="card" id="game" style="display:none">
      <div class="question" id="qText"></div>
      <div class="opts" id="opts"></div>

      <div class="meta">
        <div>Q <span id="idx">1</span>/<span id="total">10</span> ‚Ä¢ Score: <b id="score">0</b></div>
        <div class="progress" style="width:48%"><div class="fill" id="bar" style="width:100%"></div></div>
      </div>
      <div class="feedback" id="fb"></div>
      <div class="center">
        <button id="skip">Skip</button>
        <button id="next" disabled>Next</button>
      </div>
      <div class="small">Tip: press keys <b>1‚Äì4</b> to choose. No arrow keys used (Notion-safe).</div>
    </div>

    <div class="card" id="end" style="display:none">
      <div style="font-size:18px;margin-bottom:8px">Session complete üéâ</div>
      <div class="row">
        <span class="badge">Score: <b id="finalScore">0</b></span>
        <span class="badge">Best: <b id="finalBest">‚Äî</b></span>
        <span class="badge">Accuracy: <b id="acc">0%</b></span>
      </div>
      <hr>
      <div id="summary" class="small"></div>
      <div class="center">
        <button id="again" class="primary">Play Again</button>
      </div>
    </div>
  </div>
</div>

<script>
/* --------------------------
   English Fill-the-Blank
   - MCQ 4 options
   - Timer per question
   - 1‚Äì4 hotkeys
   - Local best score
---------------------------*/

const BANK = [
  // Articles / Prepositions / Collocations / Tenses / Phrasal verbs / Common mistakes
  { s:"She is ___ honest person.", a:"an", d:["a","the","‚Äî"], e:"Vowel sound ‚Üí use ‚Äúan‚Äù." },
  { s:"I will call you ___ Monday.", a:"on", d:["in","at","by"], e:"Days of the week ‚Üí ‚Äúon‚Äù." },
  { s:"He is interested ___ music production.", a:"in", d:["on","for","about"], e:"‚Äúinterested in + noun/gerund‚Äù." },
  { s:"They arrived ___ the airport early.", a:"at", d:["to","in","on"], e:"Specific point/place ‚Üí ‚Äúat‚Äù." },
  { s:"I have been living here ___ 2019.", a:"since", d:["for","from","by"], e:"Starting point ‚Üí ‚Äúsince‚Äù." },
  { s:"We waited ___ two hours.", a:"for", d:["since","during","from"], e:"Duration ‚Üí ‚Äúfor‚Äù." },
  { s:"This is the boy ___ won the race.", a:"who", d:["which","whom","whose"], e:"Subject relative pronoun for people ‚Üí ‚Äúwho‚Äù." },
  { s:"The book ___ I bought is expensive.", a:"that", d:["who","whom","whose"], e:"Object relative ‚Üí ‚Äúthat/which‚Äù." },
  { s:"If it ___ tomorrow, we will stay home.", a:"rains", d:["will rain","rained","rain"], e:"Type 1 conditional: If + present, will + base." },
  { s:"I wish I ___ taller.", a:"were", d:["was","am","be"], e:"Subjunctive after wish ‚Üí ‚Äúwere‚Äù." },
  { s:"He suggested ___ earlier.", a:"leaving", d:["to leave","leave","left"], e:"Suggest + gerund." },
  { s:"I look forward to ___ from you.", a:"hearing", d:["hear","to hear","be hearing"], e:"‚Äúlook forward to‚Äù + gerund." },
  { s:"She ___ already ___ breakfast.", a:"has, had", d:["have, had","has, have","had, had"], e:"Present perfect: has/have + past participle (had)." },
  { s:"By this time next year, I ___ my degree.", a:"will have completed", d:["will complete","complete","am completing"], e:"Future perfect: will have + past participle." },
  { s:"Please ___ the lights before you leave.", a:"turn off", d:["turn of","put off","turn up"], e:"Phrasal verb: turn off (switch off)." },
  { s:"We need to ___ the meeting to Friday.", a:"move", d:["shift up","bring on","post"], e:"Natural collocation ‚Üí ‚Äúmove the meeting‚Äù." },
  { s:"He is good ___ solving problems.", a:"at", d:["in","on","to"], e:"Adjective + preposition: good at." },
  { s:"I‚Äôm not used ___ spicy food.", a:"to", d:["with","for","at"], e:"‚Äúbe used to‚Äù + noun/gerund." },
  { s:"Neither of the answers ___ correct.", a:"is", d:["are","were","be"], e:"‚ÄúNeither‚Äù is singular ‚Üí ‚Äúis‚Äù." },
  { s:"There ___ a lot of traffic today.", a:"is", d:["are","were","have"], e:"‚Äúa lot of traffic‚Äù ‚Üí uncountable, singular verb." },
  { s:"We discussed the plan ___ detail.", a:"in", d:["on","with","by"], e:"Fixed phrase: in detail." },
  { s:"I prefer tea ___ coffee.", a:"to", d:["than","over","instead"], e:"Prefer A to B." },
  { s:"She insisted ___ paying the bill.", a:"on", d:["to","for","at"], e:"Insist on + gerund." },
  { s:"It depends ___ the weather.", a:"on", d:["in","of","for"], e:"Depends on." },
  { s:"He apologized ___ being late.", a:"for", d:["to","about","on"], e:"Apologize for (something)." },
  { s:"I couldn‚Äôt help ___.", a:"laughing", d:["to laugh","laugh","being laugh"], e:"‚Äúcan‚Äôt help‚Äù + gerund." },
  { s:"Hardly ___ I sat down when the phone rang.", a:"had", d:["have","did","was"], e:"Inversion with ‚Äúhardly ‚Ä¶ when‚Äù ‚Üí past perfect auxiliary ‚Äúhad‚Äù + subject." },
  { s:"No sooner had she arrived ___ it started to rain.", a:"than", d:["when","then","but"], e:"‚ÄúNo sooner ‚Ä¶ than ‚Ä¶‚Äù pair." },
  { s:"He is the ___ player in the team.", a:"best", d:["better","good","well"], e:"Superlative ‚Üí best." },
  { s:"Each of the students ___ a laptop.", a:"has", d:["have","are having","had"], e:"‚ÄúEach‚Äù takes singular verb." }
];

// state
let session = [];
let idx = 0, score = 0, correct = 0, totalQ = 10, timePerQ = 15;
let ticking = null, left = 15;
const els = {
  start: qs('#start'), qCount: qs('#qCount'), timerSel: qs('#timerSel'), best: qs('#best'),
  game: qs('#game'), end: qs('#end'), qText: qs('#qText'), opts: qs('#opts'),
  idx: qs('#idx'), total: qs('#total'), score: qs('#score'), bar: qs('#bar'),
  fb: qs('#fb'), skip: qs('#skip'), next: qs('#next'),
  finalScore: qs('#finalScore'), finalBest: qs('#finalBest'), acc: qs('#acc'), summary: qs('#summary'),
  again: qs('#again')
};

// utils
function qs(sel){ return document.querySelector(sel); }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function sample(arr,n){ return shuffle(arr.slice()).slice(0,n); }
function tplBlank(str){ return str.replace('___','<span class="blank">_____</span>'); }

// best score
const BEST_KEY='efb_best';
function loadBest(){ const v=localStorage.getItem(BEST_KEY); return v?+v:null; }
function saveBest(x){ localStorage.setItem(BEST_KEY, String(x)); }
function setBestLabel(){
  const b=loadBest(); els.best.textContent = 'Best: ' + (b==null?'‚Äî':b);
}
setBestLabel();

// start
els.start.addEventListener('click', ()=>{
  totalQ = +els.qCount.value;
  timePerQ = +els.timerSel.value;
  session = buildSession(totalQ);
  idx=0; score=0; correct=0;
  els.total.textContent = totalQ;
  els.score.textContent = score;
  els.game.style.display='block';
  els.end.style.display='none';
  renderQ();
});

// build questions
function buildSession(n){
  const items = sample(BANK, n);
  return items.map(q=>{
    const choices = shuffle([q.a, ...sample(q.d, Math.min(3,q.d.length))]).slice(0,4);
    if(!choices.includes(q.a)){ choices[Math.floor(Math.random()*choices.length)] = q.a; }
    return { s:q.s, a:q.a, e:q.e, choices };
  });
}

// render question
function renderQ(){
  clearTick();
  const q = session[idx];
  els.idx.textContent = idx+1;
  els.qText.innerHTML = tplBlank(q.s);
  els.opts.innerHTML = '';
  els.fb.textContent = '';
  els.next.disabled = true;

  q.choices.forEach((c,i)=>{
    const b=document.createElement('button');
    b.className='opt kb';
    b.dataset.kb=String(i+1);
    b.innerHTML = `<b>${c}</b>`;
    b.onclick = ()=> choose(c,b);
    els.opts.appendChild(b);
  });

  // timer
  left = timePerQ;
  tick();
}

// timer
function tick(){
  els.bar.style.width = '100%';
  const start = Date.now();
  function frame(){
    const elapsed = (Date.now()-start)/1000;
    const remain = Math.max(0, timePerQ - elapsed);
    const pct = remain/timePerQ*100;
    els.bar.style.width = pct+'%';
    if(remain<=0){ timeUp(); }
    else { ticking = requestAnimationFrame(frame); }
  }
  ticking = requestAnimationFrame(frame);
}
function clearTick(){ if(ticking){ cancelAnimationFrame(ticking); ticking=null; } }
function timeUp(){
  clearTick();
  lockOptions();
  els.fb.textContent = `‚è≥ Time up! Correct: ${session[idx].a}`;
  els.fb.className = 'feedback bad';
  els.next.disabled=false;
}

function lockOptions(){
  [...els.opts.children].forEach(b=> b.disabled=true);
}

// choose
function choose(val, btn){
  clearTick();
  lockOptions();
  const q = session[idx];
  if(val===q.a){
    btn.classList.add('correct');
    els.fb.textContent = '‚úÖ Correct!';
    els.fb.className = 'feedback good';
    score += 10;
    correct += 1;
  }else{
    btn.classList.add('wrong');
    // highlight correct
    [...els.opts.children].forEach(b=> { if(b.textContent.trim()===q.a) b.classList.add('correct'); });
    els.fb.innerHTML = `‚ùå Wrong ‚Äî <b>${q.a}</b>. <span style="color:#a9b6c5">(${q.e})</span>`;
    els.fb.className = 'feedback bad';
  }
  els.score.textContent = score;
  els.next.disabled=false;
}

// next / skip
els.next.addEventListener('click', goNext);
els.skip.addEventListener('click', ()=>{
  clearTick();
  lockOptions();
  els.fb.textContent = `‚Ü∑ Skipped ‚Äî Correct: ${session[idx].a}`;
  els.fb.className = 'feedback bad';
  els.next.disabled=false;
});

function goNext(){
  idx++;
  if(idx>=session.length){ endGame(); }
  else { renderQ(); }
}

// keyboard 1-4, n, s
window.addEventListener('keydown', (e)=>{
  const k=e.key;
  if(!els.game || els.game.style.display==='none') return;
  if(k>='1' && k<='4'){
    const i=+k-1;
    const btn = els.opts.children[i];
    if(btn && !btn.disabled) btn.click();
  }
  if(k==='n' || k==='N'){ if(!els.next.disabled) goNext(); }
  if(k==='s' || k==='S'){ if(!els.skip.disabled) els.skip.click(); }
});

// end screen
function endGame(){
  els.game.style.display='none';
  els.end.style.display='block';
  els.finalScore.textContent = score;
  const acc = Math.round((correct/session.length)*100);
  els.acc.textContent = acc+'%';

  // best
  const prev = loadBest();
  if(prev==null || score>prev) saveBest(score);
  els.finalBest.textContent = loadBest();

  // summary (first 5)
  const lines = session.slice(0, Math.min(5, session.length)).map((q,i)=>`Q${i+1}. ${q.s.replace('___', '___')} ‚Üí <b>${q.a}</b>`);
  els.summary.innerHTML = lines.join('<br>');
  setBestLabel();
}

els.again.addEventListener('click', ()=>{
  els.end.style.display='none';
  els.start.click();
});
</script>
</body>
</html>
